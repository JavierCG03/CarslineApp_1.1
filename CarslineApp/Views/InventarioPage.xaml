<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:viewmodels="clr-namespace:CarslineApp.ViewModels"
             xmlns:models="clr-namespace:CarslineApp.Models"
             x:Class="CarslineApp.Views.InventarioPage"
             x:DataType="viewmodels:InventarioViewModel"
             Title="Inventario de Refacciones"
             Shell.NavBarIsVisible="True">

    <ContentPage.Resources>
        <ResourceDictionary>
            <!-- Estilos Modernos -->
            <Style x:Key="CardFrame" TargetType="Frame">
                <Setter Property="BackgroundColor" Value="White"/>
                <Setter Property="BorderColor" Value="#E0E0E0"/>
                <Setter Property="CornerRadius" Value="12"/>
                <Setter Property="HasShadow" Value="True"/>
                <Setter Property="Padding" Value="15"/>
                <Setter Property="Margin" Value="10,8"/>
            </Style>

            <Style x:Key="NumeroParte" TargetType="Label">
                <Setter Property="FontSize" Value="15"/>
                <Setter Property="FontAttributes" Value="Bold"/>
                <Setter Property="TextColor" Value="White"/>
            </Style>

            <Style x:Key="Descripcion" TargetType="Label">
                <Setter Property="FontSize" Value="12"/>
                <Setter Property="TextColor" Value="#5F6368"/>
                <Setter Property="MaxLines" Value="2"/>
            </Style>

            <Style x:Key="StockBadge" TargetType="Frame">
                <Setter Property="Padding" Value="10,6"/>
                <Setter Property="CornerRadius" Value="12"/>
                <Setter Property="HasShadow" Value="False"/>
            </Style>

            <Style x:Key="ActionButton" TargetType="Button">
                <Setter Property="TextColor" Value="White"/>
                <Setter Property="FontSize" Value="16"/>
                <Setter Property="FontAttributes" Value="Bold"/>
                <Setter Property="WidthRequest" Value="40"/>
                <Setter Property="HeightRequest" Value="40"/>
                <Setter Property="CornerRadius" Value="20"/>
                <Setter Property="Padding" Value="0"/>
            </Style>
        </ResourceDictionary>
    </ContentPage.Resources>

    <Grid RowDefinitions="Auto,Auto,*,Auto" BackgroundColor="#F0F2F5">

        <!-- Header con gradiente -->
        <Frame Grid.Row="0"
               BackgroundColor="#3498DB"
               CornerRadius="0"
               Padding="20,30,20,20"
               HasShadow="True"
               Margin="0">
            <Grid ColumnDefinitions="*,Auto">
                <VerticalStackLayout Grid.Column="0" Spacing="5">
                    <Label Text="ðŸ“¦ Inventario"
                           FontSize="26"
                           FontAttributes="Bold"
                           TextColor="White"/>
                    <Label Text="{Binding Refacciones.Count, StringFormat='{0} refacciones registradas'}"
                           FontSize="14"
                           TextColor="White"
                           Opacity="0.9"/>
                </VerticalStackLayout>

                <!-- BotÃ³n Exportar Excel -->
                <Button Grid.Column="1"
                        Text="ðŸ“Š"
                        FontSize="24"
                        BackgroundColor="#27AE60"
                        TextColor="White"
                        WidthRequest="50"
                        HeightRequest="50"
                        CornerRadius="25"
                        Command="{Binding ExportarExcelCommand}"
                        VerticalOptions="Center"/>
            </Grid>
        </Frame>

        <!-- Indicador de carga -->
        <ActivityIndicator Grid.Row="1"
                          IsRunning="{Binding IsLoading}"
                          IsVisible="{Binding IsLoading}"
                          Color="#3498DB"
                          HeightRequest="40"
                          Margin="0,15,0,0"/>

        <!-- Lista de refacciones con RefreshView -->
        <RefreshView Grid.Row="2"
                     IsRefreshing="{Binding IsLoading}"
                     Command="{Binding RefreshCommand}"
                     RefreshColor="#3498DB">
            <ScrollView>
                <StackLayout Padding="10,5">

                    <!-- Mensaje cuando NO hay refacciones -->
                    <Frame IsVisible="{Binding HayRefacciones, Converter={StaticResource InverseBoolConverter}}"
                           BackgroundColor="White"
                           BorderColor="#E0E0E0"
                           CornerRadius="20"
                           Padding="40"
                           Margin="20,60">
                        <VerticalStackLayout HorizontalOptions="Center" 
                                           VerticalOptions="Center"
                                           Spacing="15">
                            <Label Text="ðŸ“¦"
                                   FontSize="80"
                                   HorizontalOptions="Center"/>
                            <Label Text="No hay refacciones registradas"
                                   FontSize="18"
                                   FontAttributes="Bold"
                                   HorizontalOptions="Center"
                                   TextColor="#7F8C8D"/>
                            <Label Text="Presiona el botÃ³n '+' para agregar la primera"
                                   FontSize="14"
                                   HorizontalOptions="Center"
                                   TextColor="#BDC3C7"/>
                        </VerticalStackLayout>
                    </Frame>

                    <!-- Lista de refacciones -->
                    <CollectionView ItemsSource="{Binding Refacciones}"
                                    IsVisible="{Binding HayRefacciones}">
                        <CollectionView.ItemTemplate>
                            <DataTemplate x:DataType="models:RefaccionDto">
                                <Frame Style="{StaticResource CardFrame}">
                                    <Grid RowDefinitions="Auto,Auto,Auto" 
                                          ColumnDefinitions="Auto,*,Auto"
                                          RowSpacing="10"
                                          ColumnSpacing="15">

                                        <!-- Badge de color segÃºn tipo con borde -->
                                        <Border Grid.Row="0" Grid.Column="0"
                                                BackgroundColor="{Binding ColorTipo}"
                                                Stroke="{Binding ColorTipo}"
                                                StrokeThickness="2"
                                                Padding="12"
                                                WidthRequest="55"
                                                HeightRequest="55"
                                                HorizontalOptions="Center"
                                                VerticalOptions="Center">
                                            <Border.StrokeShape>
                                                <RoundRectangle CornerRadius="12"/>
                                            </Border.StrokeShape>
                                            <Label Text="{Binding IconoTipo}"
                                                   FontSize="26"
                                                   HorizontalOptions="Center"
                                                   VerticalOptions="Center"/>
                                        </Border>

                                        <!-- NÃºmero de parte y descripciÃ³n -->
                                        <VerticalStackLayout Grid.Row="0" Grid.Column="1" 
                                                           Spacing="5"
                                                           VerticalOptions="Center">
                                            <Label Text="{Binding NumeroParte}"
                                                   FontSize="16"
                                                   FontAttributes="Bold"
                                                   TextColor="#1A1A1A"/>
                                            <Label Text="{Binding DescripcionCompleta}"
                                                   Style="{StaticResource Descripcion}"/>
                                        </VerticalStackLayout>

                                        <!-- Stock Badge con borde -->
                                        <Border Grid.Row="0" Grid.Column="2"
                                                BackgroundColor="{Binding ColorStockFondo}"
                                                Stroke="{Binding ColorStock}"
                                                StrokeThickness="2"
                                                Padding="12,8"
                                                VerticalOptions="Center"
                                                MinimumWidthRequest="50">
                                            <Border.StrokeShape>
                                                <RoundRectangle CornerRadius="10"/>
                                            </Border.StrokeShape>
                                            <Label Text="{Binding Cantidad}"
                                                   FontSize="20"
                                                   FontAttributes="Bold"
                                                   TextColor="{Binding ColorStock}"
                                                   HorizontalOptions="Center"/>
                                        </Border>

                                        <!-- Separador mÃ¡s visible -->
                                        <BoxView Grid.Row="1" Grid.ColumnSpan="3"
                                                 HeightRequest="1.5"
                                                 BackgroundColor="#D0D0D0"
                                                 Margin="0,5"/>
                                        <!-- Botones de acciÃ³n -->
                                        <Grid Grid.Row="2" Grid.ColumnSpan="3"
                                              ColumnDefinitions="Auto,*,Auto"
                                              ColumnSpacing="10">

                                            <!-- Botones rÃ¡pidos +1 / -1 (Izquierda) -->
                                            <HorizontalStackLayout Grid.Column="0"
                                                                 Spacing="8">
                                                <!-- BotÃ³n +1 RÃ¡pido -->
                                                <Button Text="+1"
                                                       FontSize="14"
                                                       FontAttributes="Bold"
                                                       BackgroundColor="#27AE60"
                                                       TextColor="White"
                                                       WidthRequest="45"
                                                       HeightRequest="35"
                                                       CornerRadius="8"
                                                       Padding="0"
                                                       Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:InventarioViewModel}}, Path=AumentarUnoCommand}"
                                                       CommandParameter="{Binding .}"/>

                                                <!-- BotÃ³n -1 RÃ¡pido -->
                                                <Button Text="-1"
                                                       FontSize="14"
                                                       FontAttributes="Bold"
                                                       BackgroundColor="#E67E22"
                                                       TextColor="White"
                                                       WidthRequest="45"
                                                       HeightRequest="35"
                                                       CornerRadius="8"
                                                       Padding="0"
                                                       Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:InventarioViewModel}}, Path=DisminuirUnoCommand}"
                                                       CommandParameter="{Binding .}"/>
                                            </HorizontalStackLayout>

                                            <!-- Botones avanzados (Derecha) -->
                                            <HorizontalStackLayout Grid.Column="2"
                                                                 Spacing="8"
                                                                 HorizontalOptions="End">

                                                <!-- BotÃ³n Aumentar (mÃºltiple) -->
                                                <Button Text="+"
                                                       Style="{StaticResource ActionButton}"
                                                       BackgroundColor="#27AE60"
                                                       Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:InventarioViewModel}}, Path=AumentarCommand}"
                                                       CommandParameter="{Binding .}"/>

                                                <!-- BotÃ³n Disminuir (mÃºltiple) -->
                                                <Button Text="âˆ’"
                                                       Style="{StaticResource ActionButton}"
                                                       BackgroundColor="#E67E22"
                                                       Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:InventarioViewModel}}, Path=DisminuirCommand}"
                                                       CommandParameter="{Binding .}"/>

                                                <!-- BotÃ³n Eliminar -->
                                                <Button Text="ðŸ—‘"
                                                       Style="{StaticResource ActionButton}"
                                                       BackgroundColor="#E74C3C"
                                                       Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:InventarioViewModel}}, Path=EliminarCommand}"
                                                       CommandParameter="{Binding .}"/>

                                            </HorizontalStackLayout>
                                        </Grid>
                                      
                                    </Grid>
                                </Frame>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>

                </StackLayout>
            </ScrollView>
        </RefreshView>

        <!-- Botones inferiores -->
        <Grid Grid.Row="3" 
              ColumnDefinitions="*,Auto"
              Padding="15"
              ColumnSpacing="10"
              BackgroundColor="White"
              HeightRequest="80">

            <!-- BotÃ³n Agregar -->
            <Button Grid.Column="0"
                   Text="+ Agregar RefacciÃ³n"
                   BackgroundColor="#3498DB"
                   TextColor="White"
                   FontAttributes="Bold"
                   FontSize="16"
                   CornerRadius="12"
                   HeightRequest="50"
                   Command="{Binding AgregarRefaccionCommand}"/>

            <!-- BotÃ³n Volver -->
            <Button Grid.Column="1"
                   Text="Volver"
                   BackgroundColor="#95A5A6"
                   TextColor="White"
                   FontAttributes="Bold"
                   FontSize="16"
                   CornerRadius="12"
                   WidthRequest="100"
                   HeightRequest="50"
                   Command="{Binding VolverCommand}"/>
        </Grid>

    </Grid>
</ContentPage>